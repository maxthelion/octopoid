#!/usr/bin/env bash
# Fake gh CLI for testing — returns controlled responses via environment variables.
#
# Variables:
#   GH_MOCK_PR_NUMBER    PR number to return (default: 99)
#   GH_MOCK_MERGE_STATUS mergeStateStatus / mergeable value for gh pr view (default: CLEAN)
#   GH_MOCK_MERGE_FAIL   if "true", gh pr merge exits non-zero (default: false)
#   GH_MOCK_PR_EXISTS    if "true", gh pr view <branch> with -q returns URL+number (default: false)
#   GH_MOCK_CREATE_FAIL  if "true", gh pr create exits non-zero with generic error (default: false)
#   GH_STATE_FILE        if set, path to JSON file for stateful PR tracking:
#                          - pr view <branch>: looks up PR by branch in state file
#                          - pr create:        writes new PR to state file
#   GH_MOCK_LOG          if set, all calls are appended to this file

GH_MOCK_PR_NUMBER="${GH_MOCK_PR_NUMBER:-99}"
GH_MOCK_MERGE_STATUS="${GH_MOCK_MERGE_STATUS:-CLEAN}"
GH_MOCK_MERGE_FAIL="${GH_MOCK_MERGE_FAIL:-false}"
GH_MOCK_PR_EXISTS="${GH_MOCK_PR_EXISTS:-false}"
GH_MOCK_CREATE_FAIL="${GH_MOCK_CREATE_FAIL:-false}"
MOCK_REPO="mock/repo"

# Log the call if GH_MOCK_LOG is set
if [ -n "${GH_MOCK_LOG:-}" ]; then
    echo "gh $*" >> "$GH_MOCK_LOG"
fi

if [ $# -lt 2 ]; then
    echo "fake-gh: not enough arguments" >&2
    exit 1
fi

subcmd="$1"
subcmd2="$2"
shift 2

case "$subcmd $subcmd2" in
    "pr create")
        # gh pr create --base <base> --head <branch> --title <title> --body <body>
        if [ "${GH_MOCK_CREATE_FAIL}" = "true" ]; then
            echo "error: unexpected error creating pull request" >&2
            exit 1
        fi

        # Extract --head branch argument
        BRANCH=""
        PREV=""
        for arg in "$@"; do
            if [ "$PREV" = "--head" ]; then
                BRANCH="$arg"
                break
            fi
            PREV="$arg"
        done

        PR_URL="https://github.com/${MOCK_REPO}/pull/${GH_MOCK_PR_NUMBER}"

        # Store in state file if set
        if [ -n "${GH_STATE_FILE:-}" ] && [ -n "$BRANCH" ]; then
            GH_STATE_FILE="${GH_STATE_FILE}" GH_BRANCH="${BRANCH}" \
            GH_PR_URL="${PR_URL}" GH_PR_NUMBER="${GH_MOCK_PR_NUMBER}" \
            python3 -c "
import json, os
state_file = os.environ['GH_STATE_FILE']
branch = os.environ['GH_BRANCH']
url = os.environ['GH_PR_URL']
number = int(os.environ['GH_PR_NUMBER'])
try:
    state = json.load(open(state_file))
except (FileNotFoundError, json.JSONDecodeError):
    state = {}
state.setdefault('prs', {})[branch] = {'url': url, 'number': number}
json.dump(state, open(state_file, 'w'))
"
        fi

        echo "$PR_URL"
        ;;

    "pr view")
        # Two patterns:
        #   gh pr view <num_or_branch> --json mergeable          → full JSON
        #   gh pr view <num_or_branch> --json url,number -q ...  → URL+number (or fail)
        BRANCH_ARG="$1"
        HAS_Q=false
        for arg in "$@"; do
            if [ "$arg" = "-q" ]; then
                HAS_Q=true
                break
            fi
        done

        if $HAS_Q; then
            # Called with -q to extract a specific field — used to check if a PR
            # already exists for a branch. Check state file first, then GH_MOCK_PR_EXISTS.
            if [ -n "${GH_STATE_FILE:-}" ] && [ -f "${GH_STATE_FILE}" ]; then
                STATE_OUTPUT=$(GH_STATE_FILE="${GH_STATE_FILE}" GH_BRANCH="${BRANCH_ARG}" \
                python3 -c "
import json, sys, os
state_file = os.environ['GH_STATE_FILE']
branch = os.environ['GH_BRANCH']
try:
    state = json.load(open(state_file))
    pr = state.get('prs', {}).get(branch)
    if pr:
        print(pr['url'] + ' ' + str(pr['number']))
    else:
        sys.exit(1)
except Exception:
    sys.exit(1)
")
                if [ $? -eq 0 ] && [ -n "$STATE_OUTPUT" ]; then
                    echo "$STATE_OUTPUT"
                    exit 0
                fi
            fi

            # Fall back to GH_MOCK_PR_EXISTS
            if [ "${GH_MOCK_PR_EXISTS}" = "true" ]; then
                echo "https://github.com/${MOCK_REPO}/pull/${GH_MOCK_PR_NUMBER} ${GH_MOCK_PR_NUMBER}"
            else
                echo "no pull requests found for branch" >&2
                exit 1
            fi
        else
            # Return full JSON with merge status fields
            printf '{"number":%s,"url":"https://github.com/%s/pull/%s","mergeable":"%s","mergeStateStatus":"%s"}\n' \
                "$GH_MOCK_PR_NUMBER" "$MOCK_REPO" "$GH_MOCK_PR_NUMBER" \
                "$GH_MOCK_MERGE_STATUS" "$GH_MOCK_MERGE_STATUS"
        fi
        ;;

    "pr merge")
        # gh pr merge <num> [--squash|--merge|--rebase] ...
        if [ "${GH_MOCK_MERGE_FAIL}" = "true" ]; then
            echo "error: pull request merge failed" >&2
            exit 1
        fi
        echo "Merged pull request #${GH_MOCK_PR_NUMBER}"
        ;;

    "pr list")
        # gh pr list --state open --json number [--label <label>]
        echo "[]"
        ;;

    "issue comment")
        # gh issue comment <number> --body "..."
        echo "Created comment on issue"
        ;;

    *)
        echo "fake-gh: unhandled command: $subcmd $subcmd2 $*" >&2
        exit 1
        ;;
esac
