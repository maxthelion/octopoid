#!/usr/bin/env python3
"""Mark task as complete and write result.json."""

import json
import os
import sys
from pathlib import Path

TASK_ID = os.environ.get("TASK_ID", "")
SERVER_URL = os.environ.get("OCTOPOID_SERVER_URL", "")
RESULT_FILE = os.environ.get("RESULT_FILE", "../result.json")
NOTES_FILE = os.environ.get("NOTES_FILE", "../notes.md")


def main() -> int:
    result_path = Path(RESULT_FILE)

    # Read existing result if submit-pr already wrote one
    existing = {}
    if result_path.exists():
        try:
            existing = json.loads(result_path.read_text())
        except (json.JSONDecodeError, OSError):
            pass

    # Merge with finish outcome
    existing.setdefault("outcome", "done")

    # Read notes.md and include as execution_notes
    notes_path = Path(NOTES_FILE)
    if notes_path.exists():
        try:
            existing["execution_notes"] = notes_path.read_text().strip()
        except OSError:
            pass

    result_path.write_text(json.dumps(existing, indent=2))
    print(f"Task {TASK_ID} marked as complete")
    return 0


if __name__ == "__main__":
    sys.exit(main())
