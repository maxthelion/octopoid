#!/usr/bin/env python3
"""Push branch and create a pull request. Records hook evidence."""

import json
import os
import sys

# Env vars set by the scheduler in env.sh
TASK_ID = os.environ.get("TASK_ID", "")
TASK_TITLE = os.environ.get("TASK_TITLE", "Untitled")
BASE_BRANCH = os.environ.get("BASE_BRANCH", "main")
AGENT_NAME = os.environ.get("AGENT_NAME", "unknown")
SERVER_URL = os.environ.get("OCTOPOID_SERVER_URL", "")
RESULT_FILE = os.environ.get("RESULT_FILE", "../result.json")

# Add orchestrator to path
ORCHESTRATOR_PYTHONPATH = os.environ.get("ORCHESTRATOR_PYTHONPATH", "")
if ORCHESTRATOR_PYTHONPATH:
    sys.path.insert(0, ORCHESTRATOR_PYTHONPATH)

from pathlib import Path
from orchestrator.repo_manager import RepoManager


def main() -> int:
    worktree = Path.cwd()
    repo = RepoManager(worktree=worktree, base_branch=BASE_BRANCH)

    # Get stdout summary from last few commits for PR body
    try:
        import subprocess
        log_result = subprocess.run(
            ["git", "log", f"origin/{BASE_BRANCH}..HEAD", "--oneline"],
            cwd=worktree, capture_output=True, text=True, check=False,
        )
        commits_summary = log_result.stdout.strip() if log_result.returncode == 0 else ""
    except Exception:
        commits_summary = ""

    pr_body = (
        f"## Summary\n\n"
        f"Automated implementation for task [{TASK_ID}].\n\n"
        f"## Changes\n\n```\n{commits_summary}\n```\n\n"
        f"---\nGenerated by orchestrator agent: {AGENT_NAME}"
    )

    try:
        pr = repo.create_pr(
            title=f"[{TASK_ID}] {TASK_TITLE}",
            body=pr_body,
        )
        print(f"PR: {pr.url} (new={pr.created})")

        # Record hook evidence with server
        _record_evidence("create_pr", "passed", {
            "pr_url": pr.url,
            "pr_number": pr.number,
        })

        # Write result
        _write_result({
            "outcome": "submitted",
            "pr_url": pr.url,
            "pr_number": pr.number,
        })

        return 0

    except Exception as e:
        print(f"Error creating PR: {e}", file=sys.stderr)
        _record_evidence("create_pr", "failed", {"error": str(e)})
        return 1


def _record_evidence(hook_name: str, status: str, data: dict) -> None:
    """Record hook evidence with the API server."""
    if not SERVER_URL or not TASK_ID:
        return
    try:
        import urllib.request
        url = f"{SERVER_URL}/api/v1/tasks/{TASK_ID}/hooks/{hook_name}/complete"
        payload = json.dumps({"status": status, "evidence": data}).encode()
        req = urllib.request.Request(
            url, data=payload, method="POST",
            headers={"Content-Type": "application/json"},
        )
        urllib.request.urlopen(req, timeout=10)
    except Exception as e:
        print(f"Warning: Failed to record evidence: {e}", file=sys.stderr)


def _write_result(data: dict) -> None:
    """Write result.json for the scheduler to read."""
    try:
        result_path = Path(RESULT_FILE)
        result_path.write_text(json.dumps(data, indent=2))
    except Exception as e:
        print(f"Warning: Failed to write result: {e}", file=sys.stderr)


if __name__ == "__main__":
    sys.exit(main())
