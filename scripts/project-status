#!/usr/bin/env python3
"""Show project status with task breakdown."""

import sys
from pathlib import Path

# Add parent to path for imports
sys.path.insert(0, str(Path(__file__).parent.parent))

from orchestrator.queue_utils import get_project_status, list_projects
from orchestrator.config import is_db_enabled


def main():
    if not is_db_enabled():
        print("Error: Database mode required for project status")
        sys.exit(1)

    if len(sys.argv) < 2:
        # List all projects
        projects = list_projects()
        if not projects:
            print("No projects found.")
            return

        print(f"Projects ({len(projects)}):\n")
        print(f"{'ID':<16} {'Title':<35} {'Status':<10} {'Tasks'}")
        print("-" * 75)

        for p in projects:
            project_id = p['id']
            title = p['title'][:33] if len(p['title']) > 35 else p['title']
            status = p.get('status', 'unknown')

            # Get task counts
            ps = get_project_status(project_id)
            if ps:
                by_queue = ps.get('tasks_by_queue', {})
                done = by_queue.get('done', 0)
                total = ps.get('task_count', 0)
                tasks_str = f"{done}/{total}"
            else:
                tasks_str = "-"

            print(f"{project_id:<16} {title:<35} {status:<10} {tasks_str}")
        return

    # Show specific project
    project_id = sys.argv[1]
    status = get_project_status(project_id)

    if not status:
        print(f"Project not found: {project_id}")
        sys.exit(1)

    project = status['project']
    print(f"Project: {project['id']}")
    print(f"Title: {project['title']}")
    print(f"Status: {project.get('status', 'unknown')}")
    print(f"Branch: {project.get('branch', 'N/A')}")
    print(f"Base: {project.get('base_branch', 'main')}")
    print()

    # Task summary
    by_queue = status.get('tasks_by_queue', {})
    total = status.get('task_count', 0)
    blocked = status.get('blocked_count', 0)

    print(f"Tasks ({total} total):")
    print(f"  Done:      {by_queue.get('done', 0)}")
    print(f"  Claimed:   {by_queue.get('claimed', 0)}")
    print(f"  Incoming:  {by_queue.get('incoming', 0)}")
    print(f"  Breakdown: {by_queue.get('breakdown', 0)}")
    print(f"  Failed:    {by_queue.get('failed', 0)}")
    if blocked:
        print(f"  Blocked:   {blocked}")
    print()

    # Task list
    tasks = status.get('tasks', [])
    if tasks:
        print("Task details:")
        print("-" * 60)

        # Status icons
        icons = {
            'done': '✓',
            'claimed': '○',
            'incoming': '·',
            'breakdown': '↓',
            'failed': '✗',
            'provisional': '?',
        }

        for t in tasks:
            task_id = t.get('id', '')[:8]
            title = t.get('title', 'Unknown')[:40]
            queue = t.get('queue', 'unknown')
            icon = icons.get(queue, '?')
            blocked_by = t.get('blocked_by', '')

            blocked_str = f" (blocked by {blocked_by})" if blocked_by else ""
            print(f"  {icon} {task_id}: {title}{blocked_str}")


if __name__ == "__main__":
    main()
