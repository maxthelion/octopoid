#!/usr/bin/env python3
"""Detect and run project tests. Records hook evidence."""

import json
import os
import subprocess
import sys
from pathlib import Path

TASK_ID = os.environ.get("TASK_ID", "")
SERVER_URL = os.environ.get("OCTOPOID_SERVER_URL", "")
RESULT_FILE = os.environ.get("RESULT_FILE", "../result.json")


def main() -> int:
    worktree = Path.cwd()

    # Detect test runner
    test_commands = []
    if (worktree / "pytest.ini").exists() or (worktree / "pyproject.toml").exists():
        test_commands.append(["python", "-m", "pytest", "--tb=short", "-q"])
    if (worktree / "package.json").exists():
        test_commands.append(["npm", "test"])
    if (worktree / "Makefile").exists():
        test_commands.append(["make", "test"])

    if not test_commands:
        print("No test runner detected, skipping tests")
        _record_evidence("run_tests", "passed", {"skipped": True})
        return 0

    cmd = test_commands[0]
    print(f"Running: {' '.join(cmd)}")

    try:
        result = subprocess.run(
            cmd, cwd=worktree, capture_output=True, text=True, timeout=300,
        )

        if result.returncode == 0:
            print("Tests passed")
            _record_evidence("run_tests", "passed", {
                "command": " ".join(cmd),
                "output": result.stdout[-500:] if result.stdout else "",
            })
            return 0
        else:
            output = (result.stdout + "\n" + result.stderr)[-2000:]
            print(f"Tests failed (exit code {result.returncode})")
            print(output)
            _record_evidence("run_tests", "failed", {
                "command": " ".join(cmd),
                "exit_code": result.returncode,
                "output": output,
            })
            return 1

    except subprocess.TimeoutExpired:
        print("Tests timed out after 300s")
        _record_evidence("run_tests", "failed", {"error": "timeout"})
        return 1
    except FileNotFoundError:
        print(f"Test runner not found: {cmd[0]}")
        _record_evidence("run_tests", "passed", {"skipped": True, "reason": f"{cmd[0]} not found"})
        return 0


def _record_evidence(hook_name: str, status: str, data: dict) -> None:
    if not SERVER_URL or not TASK_ID:
        return
    try:
        import urllib.request
        url = f"{SERVER_URL}/api/v1/tasks/{TASK_ID}/hooks/{hook_name}/complete"
        payload = json.dumps({"status": status, "evidence": data}).encode()
        req = urllib.request.Request(
            url, data=payload, method="POST",
            headers={"Content-Type": "application/json"},
        )
        urllib.request.urlopen(req, timeout=10)
    except Exception as e:
        print(f"Warning: Failed to record evidence: {e}", file=sys.stderr)


if __name__ == "__main__":
    sys.exit(main())
